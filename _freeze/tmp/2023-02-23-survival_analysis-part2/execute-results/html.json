{
  "hash": "e2aeaea260d4ebcfdd25c3b3092be4cb",
  "result": {
    "markdown": "---\ntitle: \"Understanding survival analysis - part 2\"\nsubtitle: \"Evaluate gene effect on patient survival using TCGA BRCA cohort\"\nauthor: \"Chun su\"\ndate: \"2023-02-23\"\ncategories: [\"statistics\", \"R\", \"bioinformatics\"]\nexecute: \n  eval: false\n  warning: false\n  message: false\nformat:\n  html:\n      code-fold: false\n      code-overflow: wrap\n---\n\n\nThis is part 2 of survival analysis using TCGA data (The part 1 refer to [blog](https://learningwithsckinta.netlify.app/posts/2023-01-16-survival_analysis.html)). In this post, I will focus on Cox proportion hazard test, which is more flexible survival test than log rank test and frequently used in scientific publications [^1].\n\n[^1]: Nagy, Á., Munkácsy, G. & Győrffy, B. Pancancer survival analysis of cancer hallmark genes. Sci Rep 11, 6047 (2021). https://doi.org/10.1038/s41598-021-84787-5\n[^1]: Xuanjin Cheng, Yongxing Liu, Jiahe Wang, Yujie Chen, Andrew Gordon Robertson, Xuekui Zhang, Steven J M Jones, Stefan Taubert, cSurvival: a web resource for biomarker interactions in cancer outcomes and in cell lines, Briefings in Bioinformatics, Volume 23, Issue 3, May 2022, bbac090, https://doi.org/10.1093/bib/bbac090\n\n\n# Cox proportional hazard\n\n## hazard function\n\nProportional hazard is relative hazard at $t$ to baseline hazard ($t_0$). We use hazard function to model hazard at either time point. \n\nHere are 5 functions used to measure probability of death/hazard or survival with $t$ as independent variable.\n\n-   **cumulative distribution function F(t)**: cumulative of probability of dying past time t.\n\n-   **probability density function f(t)**: $f(t) = F'(t)$, the rate of probability of dying across t.\n\n-   **survival function S(t)**: $S(t)=1-F(t)$, cumulative of probability of survival past time t;\n\n-   **hazard function/rate h(t)**: $h(t)=\\frac{f(t)}{S(t)}$, By formula it means the death rate in the instant after time t given survival past that time t; It is also called *\"an instantaneous risk of dying at time t\"*.\n\n-   **cumulative hazard H(t)**: $H(t)=\\int_{0}^t h(t)dt = -ln(S(t))$, measures the total amount of risk that has been accumulated up to a certain point of time t.\n\n## proportional hazard assumption\n\n**Proportional hazard assumption**: $\\frac {h(t|x_i)} {h(t_0)} = \\sum_{j=1}^p exp(\\beta_i*x_{ij})$ \n\n- h(t0) is the **baseline hazard**, which was not specified. No assumptions is made about about its functional form.\n- $\\frac {h(t|x_i)} {h(t_0)}$ measures **relative risk** for the feature vector $x_i = (x_{i1}, . . . , x_{ip})^T$ , relative to that for the feature vector $x_i =(0,...,0)^T$.\n\nTo interpretation the coefficients $\\beta$, we will say *a one-unit increase in $x_{ij}$ corresponds to an increase in $h(t|x_i)$ by a factor of $exp(\\beta_{j})$*.\n\n### how to evaluate proportional hazard assumption hold?\n\n-   Method 1: Using K-M survival curve if X is single binary variable\n\nIn the model with single binary variable $x_i \\in \\{0,1\\}$, under the proportional hazards assumption, the log hazard functions differ by a constant ($\\beta$), thus log hazard function of $x_i=0$ will be parallel to thus log hazard functions of $x_i=1$. Thus, the survival curves ($x_i=0$ vs $x_i=1$) do not cross. If assumption does not hold, the log hazard functions and survival function will cross, like the TNBC example in part 1.\n\n![](https://learningwithsckinta.netlify.app/posts/2023-01-16-survival_analysis_files/figure-html/unnamed-chunk-5-1.png)\n\n-   Method 2: Testing of scaled Schoenfeld residuals\n\n> In situations when the proportional hazards assumption of the Cox regression model does not hold, we say that the **effect of the co-variate is time-varying**. The proportional hazards assumption can be tested by examining the residuals of the model [^9]. \n\n[^9]: Zhang Z, Reinikainen J, Adeleke KA, Pieterse ME, Groothuis-Oudshoorn CGM. Time-varying covariates and coefficients in Cox regression models. Ann Transl Med. 2018 Apr;6(7):121. doi: 10.21037/atm.2018.02.12. PMID: 29955581; PMCID: PMC6015946.\n\n`cox.zph` function from `{survival}` package can test PH assumption of a Cox Regression for each variable. For each covariate, the function `cox.zph` correlates the corresponding set of scaled Schoenfeld residuals with time, to test for independence between residuals and time. Additionally, it performs a global test for the model as a whole. **The proportional hazard assumption is supported by a non-significant relationship between residuals and time, and refuted by a significant relationship**[^10].\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(survival)\nlibrary(tidyverse)\ntheme_set(theme_bw())\n\n# load clinical data\ntcga_cdr <- openxlsx::read.xlsx(\"https://www.cell.com/cms/10.1016/j.cell.2018.02.052/attachment/bbf46a06-1fb0-417a-a259-fd47591180e4/mmc1.xlsx\") |> \n    as_tibble() |> \n    janitor::clean_names() |> \n    filter(type==\"BRCA\")\n\n# load tnbc label\ntnbc_anno <- openxlsx::read.xlsx(\"https://doi.org/10.1371/journal.pone.0157368.s008\", sheet = \"TCGA\", startRow = 2, cols=1:44) |> \n    as_tibble() |> \n    janitor::clean_names()\n\n# add tnbc label to clinical data\ntcga_cdr <- tcga_cdr |> \n    left_join(\n        tnbc_anno |> \n            select(bcr_patient_barcode=barcode, tnbc) |> \n            distinct()\n    )\n\ncox_fit <- coxph(Surv(pfi_time, pfi) ~ tnbc, data = tcga_cdr) \nph_assumption <- cox.zph(cox_fit) # will test whether Proportional Hazards Assumption of a Cox Regression for each variable (tnbc)\n\nph_assumption\n```\n:::\n\n\nThe above test is at boarder line of significance for `tnbc` variable and global test. Therefore, from Schoenfeld residuals method, proportional hazards assumption may hold.\n\n`ph_assumption` is an object of class \"cox.zph\" with components `table` (printed in above), `x` (transformed time), `time` (untransformed time), `y` (matrix of scaled Schoenfeld residuals), `var` (a variance matrix for covariates), `transform` (input time transform method) and `call` (print calling function)\n\n[^10]: http://www.sthda.com/english/wiki/cox-model-assumptions\n\n`ggcoxzph` from R package `{survminer}` plot scaled Schoenfeld residuals ($\\beta(t)$) against transformed time. *If the proportional hazards assumption holds then the true $\\beta(t)$ function would be a horizontal line.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurvminer::ggcoxzph(ph_assumption)\n```\n:::\n\n\nHere as expected, the Schoenfeld residuals is a horizontal line, indicating proportional hazards assumption holds for this test.\n\nUse `?cox.zph` to know more about how the test reports linear models with random effect terms or strata.\n\n### solution to cox model when proportional hazard assumption does not hold.\n\n## Cox proportional hazards model\n\n-   In cox model, **hazard ratio (HR)** is $exp(\\beta_{j})$. When HR \\> 1, rate of hazard increase when x increase; while rate of hazard decrease when x increase when HR \\< 1.\n\n> Hazard ratios differ from relative risks (RRs) and odds ratios (ORs) in that RRs and ORs are cumulative over an entire study, using a defined endpoint, while HRs represent instantaneous risk over the study time period, or some subset thereof. Hazard ratios suffer somewhat less from selection bias with respect to the endpoints chosen and can indicate risks that happen before the endpoint [^11].\n\n[^11]: Shimoni Y. Association between expression of random gene sets and survival is evident in multiple cancer types and may be explained by sub-classification. PLoS Comput Biol. 2018 Feb 22;14(2):e1006026. doi: 10.1371/journal.pcbi.1006026.\n\nIn above code, we have already used `coxph` from `{survival}` to fit cox proportional hazards model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(cox_fit)\n```\n:::\n\n\nFrom model summary, there were three tests -- Likelihood ratio test, Wald test, Score (logrank) test -- to test whether the coxph model `Surv(pfi_time, pfi) ~ tnbc` significantly describe the relationship between survival curve and independent variable (`tnbc`). The model summary can be organized in data.frame format by `broom::glance(cox_fit)`.\n\n\n::: {.cell}\n\n:::\n\n\n\nFrom the coefficients summary, HR for term TNBC as \"yes\" (compared to \"no\") is 1.44 (`exp(coef) = 1.44`) and significance level is 0.0674. Thus, TNBC patients is 1.44 times greater chance of having tumor progression than non-TNBC patients at any point in time, assuming all other unseen variables randomized. The coefficient can be organized in data.frame format by `broom::tidy(cox_fit)`.\n\n\n::: {.cell}\n\n:::\n\n\n\n### example of using the expression of one single gene (`BRCA1`).\n\nTheoretically, people should be use continuous/numeric (vs. discrete/categorical) as X for coxph. However, it is not straightforward to visualize the difference of survival curves. Thus, in practice (at least when analyzing TCGA data to discover biomarkers), we usually convert continuous/numeric variable (eg. gene expression) to discrete/categorical variable (eg. high vs. low) before fitting the model.\n\nThen the question comes to which cutoff to choose. Different papers show different strategies with their own [^6].\n\n1. Use median as cutoff, aka, above median as high and below median as low [^4]. The advantage of median strategy is using all samples (small n is always a problem in TCGA analysis). The disadvantage is that model significance may be affected by small difference between two groups.\n\n2. Use top x% and down x% as cutoff [^5]. Opposite to median strategy, the bigger difference between two groups is at expense of smaller sample size. (100-2x)% samples were not used.\n\n3. Use gradients to find best cutoff [^3]. The best cutoff is defined by the coxph model significance (the lower significance the better cutoff).\n\n[^3]: Xuanjin Cheng, Yongxing Liu, Jiahe Wang, Yujie Chen, Andrew Gordon Robertson, Xuekui Zhang, Steven J M Jones, Stefan Taubert, cSurvival: a web resource for biomarker interactions in cancer outcomes and in cell lines, Briefings in Bioinformatics, Volume 23, Issue 3, May 2022, bbac090, https://doi.org/10.1093/bib/bbac090\n\n[^4]: https://www.biostars.org/p/175850/#175850\n\n[^5]: https://www.biostars.org/p/153013/\n\n[^6]: https://www.nature.com/articles/s41598-022-06841-0\n\nI wrote a function `optimal_cutoff_1d` for method 3 to find optimal. Usually we can control the sample size for the smallest group.\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptimal_cutoff_1d <- function(surv_obj, expr, low_q=0.2, high_q=0.8, breaks=10, log=T, pseudocount=1, pvalue_type=c(\"log\", \"sc\", \"wald\")[1], min_sample_n = 10){\n    if(log){\n        expr <- log2(pseudocount + expr)\n    }\n    \n    df <- map_dfr(\n        seq(low_q, high_q, length.out=breaks),\n        ~coxph(surv_obj ~ (expr > quantile(expr, .x))) |> \n                broom::glance() |> \n            mutate(q=.x) |> \n            mutate(cutoff=quantile(expr, q))\n    ) |> \n        arrange(across(paste0(\"p.value.\",pvalue_type))) |> \n     mutate(min_sample_n = ifelse(q > 0.5, (1-q)*n, q*n)) |> \n        select_at(c(\"q\",\"cutoff\", paste0(\"p.value.\",pvalue_type), \"min_sample_n\")) |> \n      mutate(keep = (min_sample_n >= !!min_sample_n))\n\n    list(q=unlist(df[df$keep,][1,1], use.names = F), df = df)\n}\n```\n:::\n\n\nNext we are going to use BRCA1 as the marker to estimate survival different on BRCA1 expression. \n\nTo obtain gene expression of BRCA1 and clinical data from cBioPortal using `{cBioPortalData}` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nBiocManager::install(\"cBioPortalData\")\nlibrary(cBioPortalData)\n\ncbio <- cBioPortal()\n\nstudy_id <- getStudies(cbio, buildReport = TRUE) |> \n    filter(grepl(\"TCGA\", name)) |> \n    filter(cancerTypeId==\"brca\") |> \n    filter(api_build) |> \n    dplyr::slice(which.max(allSampleCount)) |> \n    pull(studyId)\n\n# molecularProfiles(cbio, study_id)\n\ndata <- cBioPortalData(api = cbio, \n                      by = \"hugoGeneSymbol\", \n                      studyId = study_id,\n                      genes = c(\"BRCA1\", \"BRCA2\"),\n                      molecularProfileIds = c(\"brca_tcga_rna_seq_v2_mrna\")\n) # here I download both BRCA1 and BRCA2 expression.\n\nbrca_clinical <- colData(data) |> \n    as_tibble() |> \n    janitor::clean_names() |> \n    select(patient_id, sample_type, sample_id, os_months, os_status, age, race, sex) # use clinical data directly from bioportal\n\ngene_expr <- assay(data[['brca_tcga_rna_seq_v2_mrna']]) |> \n    as.data.frame() |> \n    rownames_to_column(\"gene_name\") |> \n    as_tibble() |> \n    pivot_longer(-gene_name, names_to=\"sample_id\", values_to = \"expr\") |> \n    pivot_wider(names_from = gene_name, values_from = expr)\n\ninput_data <- brca_clinical |> \n    left_join(gene_expr) |> \n    mutate(os_status=case_when(os_status==\"1:DECEASED\" ~ 1, \n                               os_status==\"0:LIVING\" ~ 0)) |> \n    mutate(os_status = as.integer(os_status),\n           os_months = as.numeric(os_months))\n\noptimal_q <- optimal_cutoff_1d(\n  surv_obj = with(input_data, Surv(os_months, os_status)),\n  expr = input_data$BRCA1\n)\n\noptimal_q$q\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nFinally fit coxph model using optimal cutoff\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptimal_cutoff <- quantile(input_data$BRCA1, optimal_q$q)\ncox_fit2 <- coxph(\n  Surv(os_months, os_status) ~ BRCA1_high, \n  data = input_data |> \n    mutate(BRCA1_high = BRCA1 > optimal_cutoff)\n  )\nsummary(cox_fit2)\n```\n:::\n\n\nBoth model and term are significant. Patients with higher expression of BRCA1 is 1.46 times greater chance of dying than non-TNBC patients at any point in time, assuming all other unseen variables randomized.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_surv <-\n  function(formula,\n           data,\n           strata_title = NULL,\n           x_title = NULL,\n           y_title = NULL,\n           plot_title = NULL) {\n    if (is.null(strata_title)) {\n      strata_title = \"strata\"\n    }\n    if (is.null(x_title)) {\n      x_title = \"time\"\n    }\n    if (is.null(y_title)) {\n      y_title = \"overall survival rate\"\n    }\n    \n    surv_fit2 <- survfit(formula,\n                         data = data) # survfit obj\n    \n    surv_fit2 |>\n      broom::tidy() |>\n      left_join(\n        broom::tidy(surv_fit2) |>\n          group_by(strata) |>\n          dplyr::slice(which.min(time)) |>\n          select(n = n.risk, strata)\n      ) |>\n      mutate(strata = str_replace(strata, \".*=\", \"\")) |>\n      filter(!grepl(\"\\\\[\", strata)) |>\n      mutate(strata = glue::glue(\"{strata} (n={n})\")) |>\n      ggplot(aes(x = time, y = estimate, group = strata)) +\n      geom_line(aes(color = strata)) +\n      geom_point(aes(color = strata), shape = \"|\", size = 2) +\n      geom_ribbon(aes(\n        ymax = conf.high,\n        ymin = conf.low,\n        fill = strata\n      ), alpha = 0.2) +\n      labs(x = x_title, y = y_title, color = strata_title) +\n      guides(fill = \"none\") +\n      ggtitle(plot_title)\n  }\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_surv(\n  Surv(os_months, os_status) ~ BRCA1_high, \n  data = input_data |> \n    mutate(BRCA1_high = BRCA1 > optimal_cutoff),\n  strata_title=\"BRCA1 expr. high\", \n  x_title ='time (months)', \n  plot_title = \"K-M survival curve for TCGA breast cancer (BRCA)\"\n  \n)\n```\n:::\n\n\n### example of using the expression of two genes (`BRCA1` and `BRCA2`).\n\nWhen regressing on the expression of two genes, we optimize cutoff of expression at two dimensions with function `optimal_cutoff_2d`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptimal_cutoff_2d <-\n  function(surv_obj,\n           expr1,\n           expr2,\n           low_q = 0.2,\n           high_q = 0.8,\n           breaks = 10,\n           log = T,\n           pseudocount = 1,\n           pvalue_type = c(\"log\", \"sc\", \"wald\")[1],\n           min_sample_n = 10) {\n    if (log) {\n      expr1 <- log2(pseudocount + expr1)\n      expr2 <- log2(pseudocount + expr2)\n    }\n    \n    df <- pmap_dfr(crossing(\n      q1 = seq(low_q, high_q, length.out = breaks),\n      q2 = seq(low_q, high_q, length.out = breaks)\n    ),\n    function(q1, q2) {\n      min_n <-\n        model.frame(surv_obj ~ (expr1 > quantile(expr1, q1)) + (expr2 > quantile(expr2, q2))) |>\n        na.omit() |>\n        as_tibble() |>\n        select(-surv_obj) |>\n        group_by_all() |>\n        dplyr::count() |>\n        pull(n) |> min()\n      \n      coxph(surv_obj ~ (expr1 > quantile(expr1, q1)) + (expr2 > quantile(expr2, q2))) |>\n        broom::glance() |>\n        mutate(q1 = q1, q2 = q2) |>\n        mutate(\n          cutoff1 = quantile(expr, q1),\n          cutoff2 = quantile(expr, q2),\n          min_sample_n = min_n\n        )\n    }) |>\n      arrange(across(paste0(\"p.value.\", pvalue_type))) |>\n      select_at(c(\n        \"q1\",\n        \"cutoff1\",\n        \"q2\",\n        \"cutoff2\",\n        paste0(\"p.value.\", pvalue_type),\n        \"min_sample_n\"\n      )) |>\n      mutate(keep = min_sample_n >= !!min_sample_n)\n    \n    list(q = unlist(df[df$keep, ][1, c(\"q1\",\"q2\")]), df = df)\n  }\n```\n:::\n\n\nHere we use example of BRCA1 and BRCA2 to test the effect of two gene combinatory expression pattern on patient survival\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptimal_cutoff <- optimal_cutoff_2d(\n          surv_obj= with(input_data, Surv(os_months, os_status)),\n           expr1 = input_data$BRCA1,\n           expr2 = input_data$BRCA2,\n)\n\noptimal_cutoff$q\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_surv(\n  Surv(os_months, os_status) ~ BRCA1_high + BRCA2_high, \n  data = input_data |> \n    mutate(BRCA1_high = BRCA1 > optimal_cutoff$q[\"q1\"],\n           BRCA2_high = BRCA2 > optimal_cutoff$q[\"q2\"]\n           ),\n  strata_title=\"BRCA1/2 expr. high\", \n  x_title ='time (months)', \n  plot_title = \"K-M survival curve for TCGA breast cancer (BRCA)\"\n  \n)\n```\n:::\n\n\n\n### stratify co-variate\n\nhttps://stats.stackexchange.com/questions/256148/stratification-in-cox-model\n\nhttp://rstudio-pubs-static.s3.amazonaws.com/5096_0880aaaf0df94f3b8533a1c024738246.html\n\n## shrinkage on cox model\n\n# important notes\n\n## S(t) vs. h(t)\n\n-   S(t) survival curve is the cumulative probability. that *an event that not happen* (eg. death) at given time t.\n\n-   h(t) proportional hazard is the chance/prob. that *an event that happen (death)* at given t.\n\n    -   the regression model (Cox model) y is h(t\\|x) instead of S(t), so that bigger beta corresponding to the coefficient of higher risk of death (compared to baseline h(t\\|x0)).\n\n    -   S(t) curve plotted by default does not incorporate other co-variates, thus the visualization is more corresponding to log-rank test.\n\n    -   S(t) curve can be stratified to represent co-variate corrected curve (p.484)\n\n## Misleading results in TCGA survival analysis.\n\n-   Lead time bias: choose of different events, aka, earlier diagnosis can give false perception of longer survival, and diagnosis can be biased by clinical factors (e.g. fast-growing vs slow-growing tumors, onset of various symptoms, screening triggers)\n\n-   censored data bias: violate independent assumption, aka, patients with incomplete follow-up to reach time to event can be biased (e.g. drop out of study due to rapidly deteriorating health).\n\n-   proportional hazards assumption: Cox PH model assumes relative hazards are constant over time (e.g. violated if treatment has an initial beneficial effect but reduces survival at later time points)\n\n-   Uninteresting correlations and data substructure [^12]: There are many uninteresting reasons that a random subset of genes can seem to have a significant effect on survival (e.g. correlation with a proliferation signature; association with age and age bias in hazard rates)\n\n[^12]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5839591/\n\nSome of these possibilities can be explored with additional analyses. For example, once could test hypotheses about influence of age on expression or whether a specific gene's impact on survival is more reflective of that gene's membership in a gene set associated with some broader characteristic such as tumor purity, immune infiltration, proliferation signature, tumor molecular sub type, etc.\n\n\n# other useful resource\n\n- https://github.com/mdozmorov/TCGAsurvival\n- tutorial for stratified vs subset coxph: http://rstudio-pubs-static.s3.amazonaws.com/5096_0880aaaf0df94f3b8533a1c024738246.html",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}