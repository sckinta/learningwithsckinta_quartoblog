---
title: "Understanding survival analysis - part 2"
subtitle: "Evaluate gene effect on patient survival using TCGA BRCA cohort"
author: "Chun su"
date: "2023-01-16"
categories: ["statistics", "R", "bioinformatics"]
execute: 
  warning: false
  message: false
format:
  html:
      code-fold: false
      code-overflow: wrap
---

# Cox proportional hazard

## hazard function

-   **cumulative distribution function F(t)**: cumulative of probability of dying past time t.

-   **probability density function f(t)**: $f(t) = F'(t)$, the rate of probability of dying across t.

-   **survival function S(t)**: $S(t)=1-F(t)$, cumulative of probability of survival past time t;

-   **hazard function/rate h(t)**: $h(t)=\frac{f(t)}{S(t)}$, the death rate in the instant after time t given survival past that time; an instantaneous risk of dying at time t; the number of deaths one can expect per t unit.

-   **cumulative hazard H(t)**: $H(t)=\int_{0}^t h(t)dt = -ln(S(t))$, measures the total amount of risk that has been accumulated up to a certain point of time t.

## proportional hazard assumption

**Proportional hazard assumption**: $\frac {h(t|x_i)} {h(t_0)} = \sum_{j=1}^p exp(\beta_i*x_{ij})$ in which h(t0) is the **baseline hazard**, the $\frac {h(t|x_i)} {h(t_0)}$ measures **relative risk** for the feature vector $x_i = (x_{i1}, . . . , x_{ip})^T$ , relative to that for the feature vector $x_i =(0,...,0)^T$.

**baseline hazard** do not need to be specified. We make no assumptions about its functional form.

Interpretation: a one-unit increase in $x_{ij}$ corresponds to an increase in $h(t|x_i)$ by a factor of $exp(\beta_{j})$.

### how to evaluate proportional hazard assumption hold?

-   Method 1: Using K-M survival curve!

In the model with single binary variate $x_i \in \{0,1\}$, under the proportional hazards assumption, the log hazard functions differ by a constant ($\beta$), and the survival functions do not cross. If assumption does not hold, the log hazard functions and survival function will cross, like above TNBC example.

-   Method 2: Testing of scaled Schoenfeld residuals

> In situations when the proportional hazards assumption of the Cox regression model does not hold, we say that the **effect of the co-variate is time-varying**. The proportional hazards assumption can be tested by examining the residuals of the model [^9].

[^9]: Zhang Z, Reinikainen J, Adeleke KA, Pieterse ME, Groothuis-Oudshoorn CGM. Time-varying covariates and coefficients in Cox regression models. Ann Transl Med. 2018 Apr;6(7):121. doi: 10.21037/atm.2018.02.12. PMID: 29955581; PMCID: PMC6015946.

`cox.zph` function from `{survival}` package can test PH assumption of a Cox Regression for each variable.

```{r}
cox_test <- coxph(Surv(pfi_time, pfi) ~ tnbc, data = tcga_cdr) 
ph_assumption <- cox.zph(cox_test) # will test whether Proportional Hazards Assumption of a Cox Regression for each variable (tnbc)

ph_assumption
```

The above test is at boarderline of significance for tnbc variable and global test. Therefore, proportional hazards assumption may hold.

In principle, the Schoenfeld residuals are independent of time. A plot that shows a non-random pattern against time is evidence of violation of the PH assumption [^10].

[^10]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5839591/

```{r}
survminer::ggcoxzph(ph_assumption)
```

## Cox proportional hazards model

-   In cox model, **hazard ratio (HR)** is $exp(\beta_{j})$. When HR \> 1, rate of hazard increase when x increase.

> Hazard ratios differ from relative risks (RRs) and odds ratios (ORs) in that RRs and ORs are cumulative over an entire study, using a defined endpoint, while HRs represent instantaneous risk over the study time period, or some subset thereof. Hazard ratios suffer somewhat less from selection bias with respect to the endpoints chosen and can indicate risks that happen before the endpoint [^11].

[^11]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5839591/

### solution to cox model when proportional hazard assumption does not hold.

### example

### stratify co-variate

## shrinkage on cox model

# important notes

## S(t) vs. h(t)

-   S(t) survival curve is the cumulative probability. that *an event that not happen* (eg. death) at given time t.

-   h(t) proportional hazard is the chance/prob. that *an event that happen (death)* at given t.

    -   the regression model (Cox model) y is h(t\|x) instead of S(t), so that bigger beta corresponding to the coefficient of higher risk of death (compared to baseline h(t\|x0)).

    -   S(t) curve plotted by default does not incorporate other co-variates, thus the visualization is more corresponding to log-rank test.

    -   S(t) curve can be stratified to represent co-variate corrected curve (p.484)

## Misleading results in TCGA survival analysis.

-   Lead time bias: choose of different events, aka, earlier diagnosis can give false perception of longer survival, and diagnosis can be biased by clinical factors (e.g. fast-growing vs slow-growing tumors, onset of various symptoms, screening triggers)

-   censored data bias: violate independent assumption, aka, patients with incomplete follow-up to reach time to event can be biased (e.g. drop out of study due to rapidly deteriorating health).

-   proportional hazards assumption: Cox PH model assumes relative hazards are constant over time (e.g. violated if treatment has an initial beneficial effect but reduces survival at later time points)

-   Uninteresting correlations and data substructure [^12]: There are many uninteresting reasons that a random subset of genes can seem to have a significant effect on survival (e.g. correlation with a proliferation signature; association with age and age bias in hazard rates)

[^12]: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5839591/

Some of these possibilities can be explored with additional analyses. For example, once could test hypotheses about influence of age on expression or whether a specific gene's impact on survival is more reflective of that gene's membership in a gene set associated with some broader characteristic such as tumor purity, immune infiltration, proliferation signature, tumor molecular sub type, etc.